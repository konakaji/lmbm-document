# get_geo_data関数の詳細分析

## 概要

`get_geo_data`関数は、`MODataset.py`で使用される重要な関数で、分子の幾何学的データ（原子座標、原子種、分子軌道埋め込み）をE3NNで処理可能なグラフ形式に変換します。本ドキュメントでは、10個の分子データに対する実際の動作を詳細に分析します。

## 関数の目的

`get_geo_data`関数は以下の処理を行います：

1. **原子座標のパディング**: 異なるサイズの分子を統一された形状に変換
2. **グラフ構造の生成**: 原子間の結合関係をエッジとして表現
3. **分子軌道のブロードキャスト**: 各分子軌道に対して原子の幾何学的情報を複製
4. **距離とベクトルの計算**: 原子間の距離と方向ベクトルを計算
5. **原子種のone-hotエンコーディング**: 原子種を数値ベクトルに変換

## 入力パラメータ

```python
def get_geo_data(
    atom_position,      # 原子座標 (n_atoms, 3)
    atom_type,          # 原子種 (n_atoms,)
    element_to_index,   # 原子種→インデックス変換辞書
    max_n_atom,         # 最大原子数
    max_n_mo,           # 最大分子軌道数
    max_radius,         # 最大結合半径
    max_n_neighbors,    # 最大近傍原子数
):
```

## 10個の分子での実際の動作結果

### 入力データの形状

| 分子ID | atom_positions | atom_type | mo_embeddings |
|--------|----------------|-----------|---------------|
| 0 | `[5, 3]` | `(5,)` | `[34, 5, 18]` |
| 1 | `[8, 3]` | `(8,)` | `[58, 8, 18]` |
| 2 | `[6, 3]` | `(6,)` | `[48, 6, 18]` |
| 3 | `[4, 3]` | `(4,)` | `[38, 4, 18]` |
| 4 | `[9, 3]` | `(9,)` | `[72, 9, 18]` |
| 5 | `[7, 3]` | `(7,)` | `[62, 7, 18]` |
| 6 | `[9, 3]` | `(9,)` | `[72, 9, 18]` |
| 7 | `[9, 3]` | `(9,)` | `[72, 9, 18]` |
| 8 | `[11, 3]` | `(11,)` | `[82, 11, 18]` |
| 9 | `[9, 3]` | `(9,)` | `[72, 9, 18]` |

### 出力データの形状

| 分子ID | geo_data.pos | geo_data.edge_index | geo_data.length | geo_data.vector | geo_data.one_hot | smooth_distance |
|--------|--------------|---------------------|-----------------|-----------------|------------------|-----------------|
| 0 | `[170, 3]` | `[2, 680]` | `[680, 1]` | `[680, 3]` | `[170, 9]` | `[5, 5]` |
| 1 | `[464, 3]` | `[2, 3248]` | `[3248, 1]` | `[3248, 3]` | `[464, 9]` | `[8, 8]` |
| 2 | `[288, 3]` | `[2, 1440]` | `[1440, 1]` | `[1440, 3]` | `[288, 9]` | `[6, 6]` |
| 3 | `[152, 3]` | `[2, 456]` | `[456, 1]` | `[456, 3]` | `[152, 9]` | `[4, 4]` |
| 4 | `[648, 3]` | `[2, 5184]` | `[5184, 1]` | `[5184, 3]` | `[648, 9]` | `[9, 9]` |
| 5 | `[434, 3]` | `[2, 2604]` | `[2604, 1]` | `[2604, 3]` | `[434, 9]` | `[7, 7]` |
| 6 | `[648, 3]` | `[2, 5184]` | `[5184, 1]` | `[5184, 3]` | `[648, 9]` | `[9, 9]` |
| 7 | `[648, 3]` | `[2, 5184]` | `[5184, 1]` | `[5184, 3]` | `[648, 9]` | `[9, 9]` |
| 8 | `[902, 3]` | `[2, 9020]` | `[9020, 1]` | `[9020, 3]` | `[902, 9]` | `[11, 11]` |
| 9 | `[648, 3]` | `[2, 5184]` | `[5184, 1]` | `[5184, 3]` | `[648, 9]` | `[9, 9]` |

## 形状変換の詳細分析

### 1. 位置座標のブロードキャスト

**変換**: `atom_positions [n_atoms, 3]` → `geo_data.pos [n_mo × n_atoms, 3]`

- **分子0**: `[5, 3]` → `[170, 3]` (34 × 5 = 170)
- **分子8**: `[11, 3]` → `[902, 3]` (82 × 11 = 902)

**処理内容**:
```python
pos_broadcast = einops.repeat(
    pos_padded2, "n_atoms d -> (n_mos n_atoms) d", n_mos=max_n_mo
)
```

各分子軌道に対して原子座標を複製し、`(分子軌道数 × 原子数)`の形状に変換します。

### 2. エッジインデックスの生成

**変換**: 原子間の結合関係をエッジとして表現

- **分子0**: `[2, 680]` - 680個のエッジ
- **分子8**: `[2, 9020]` - 9020個のエッジ

**処理内容**:
```python
edge_src, edge_dst = radius_graph(
    pos_padded2, max_radius, max_num_neighbors=max_n_neighbors
)
edge_src_broadcast = torch.cat([edge_src + i * max_n_atom for i in range(max_n_mo)])
edge_dst_broadcast = torch.cat([edge_dst + i * max_n_atom for i in range(max_n_mo)])
```

`radius_graph`で原子間の結合を検出し、各分子軌道に対してエッジインデックスをブロードキャストします。

### 3. 距離とベクトルの計算

**変換**: エッジの距離と方向ベクトルを計算

- **分子0**: `length [680, 1]`, `vector [680, 3]`
- **分子8**: `length [9020, 1]`, `vector [9020, 3]`

**処理内容**:
```python
vector, length = get_edge_vectors_and_lengths(
    positions=pos_padded2, edge_index=torch.stack([edge_src, edge_dst], dim=0)
)
```

各エッジについて、原子間の距離（スカラー）と方向ベクトル（3次元）を計算します。

### 4. 原子種のone-hotエンコーディング

**変換**: 原子種を数値ベクトルに変換

- **形状**: `[n_mo × n_atoms, 9]` (9は原子種の種類数)
- **分子0**: `[170, 9]` (34 × 5 = 170)
- **分子8**: `[902, 9]` (82 × 11 = 902)

**処理内容**:
```python
one_hot_encoded = one_hot_encode(atom_type, element_to_index)
one_hot_encoded_padded = pad_one_hot(one_hot_encoded, max_n_atom)
one_hot_encoded_broadcast = einops.repeat(
    one_hot_encoded_padded, "n_atoms d -> (n_mos n_atoms) d", n_mos=max_n_mo
)
```

原子種（'C', 'H', 'O'など）を9次元のone-hotベクトルに変換し、各分子軌道に対してブロードキャストします。

### 5. スムーズ距離行列

**形状**: `[n_atoms, n_atoms]`

- **分子0**: `[5, 5]`
- **分子8**: `[11, 11]`

**処理内容**:
```python
smooth_distance = smooth_distance_factor(pos_padded2, max_radius, max_n_neighbors)
```

原子間の距離に基づいて、スムーズな重み行列を計算します。近い原子ほど大きな重みを持ちます。

## 重要な特徴

### 1. 分子軌道のブロードキャスト

各分子軌道に対して原子の幾何学的情報が複製されるため、E3NNは各分子軌道を独立に処理できます。

### 2. グラフ構造の生成

`radius_graph`により、指定された半径内の原子間の結合関係が自動的に検出されます。

### 3. パディング処理

異なるサイズの分子を統一された形状に変換し、バッチ処理を可能にします。

### 4. E3NN互換性

出力されるデータ構造は、E3NNの`Data`クラスと互換性があり、等変ニューラルネットワークで直接処理できます。

## 計算量の分析

### エッジ数の計算

エッジ数は分子のサイズと結合半径に依存します：

- **分子0（5原子）**: 680エッジ
- **分子8（11原子）**: 9020エッジ

エッジ数は原子数の2乗に比例して増加する傾向があります。

### メモリ使用量

- **位置座標**: `n_mo × n_atoms × 3` 要素
- **エッジ情報**: `2 × n_edges` 要素
- **距離・ベクトル**: `n_edges × 4` 要素（距離1次元 + ベクトル3次元）
- **原子種**: `n_mo × n_atoms × 9` 要素

## エッジ構造の詳細分析

### エッジの形成ルール

`geo_data`では、以下のルールでエッジが形成されます：

#### 1. 距離ベースのエッジ形成
- **最大半径**: 5.0 Å以内の原子間にエッジが形成される
- **最大近傍数**: 各原子から最大32個の近傍原子とのエッジ

#### 2. 分子0（メタン、5原子）の場合
- **軌道0のエッジ数**: 20個
- **エッジの種類**:
  - **C-H結合**: 1.092-1.093 Å（化学結合）
  - **H-H相互作用**: 1.783-1.784 Å（非結合相互作用）
- **自己ループ**: なし

#### 3. 分子8（プロパン、11原子）の場合
- **軌道0のエッジ数**: 110個
- **エッジの種類**:
  - **C-C結合**: 1.519 Å（化学結合）
  - **C-H結合**: 1.095 Å（化学結合）
  - **長距離相互作用**: 2.149-3.463 Å（非結合相互作用）

### エッジのブロードキャスト

#### 分子軌道ごとの複製
- **総エッジ数** = **軌道0のエッジ数** × **分子軌道数**
- **分子0**: 20 × 34 = 680エッジ
- **分子8**: 110 × 82 = 9020エッジ

#### エッジインデックスの変換
```python
# 軌道0: 原子0-4のエッジ
# 軌道1: 原子5-9のエッジ（軌道0と同じ構造）
# 軌道2: 原子10-14のエッジ（軌道0と同じ構造）
```

### エッジの物理的意味

#### 1. 化学結合エッジ
- **C-C結合**: 1.5-1.6 Å
- **C-H結合**: 1.0-1.1 Å
- **C-O結合**: 1.4-1.5 Å

#### 2. 非結合相互作用エッジ
- **H-H相互作用**: 1.7-1.8 Å
- **長距離相互作用**: 2.0-3.5 Å

#### 3. 最大半径の効果
- **5.0 Å**: 化学結合と近距離非結合相互作用をカバー
- **32近傍**: 各原子の主要な相互作用を網羅

### エッジ構造の具体例

#### 分子0（メタン）のエッジ
```
軌道0のエッジ（20個）:
  1(H) -> 0(C): 1.092 Å  (C-H結合)
  2(H) -> 0(C): 1.092 Å  (C-H結合)
  3(H) -> 0(C): 1.092 Å  (C-H結合)
  4(H) -> 0(C): 1.093 Å  (C-H結合)
  0(C) -> 1(H): 1.092 Å  (C-H結合)
  2(H) -> 1(H): 1.783 Å  (H-H相互作用)
  3(H) -> 1(H): 1.783 Å  (H-H相互作用)
  4(H) -> 1(H): 1.784 Å  (H-H相互作用)
  ... (全20個のエッジ)
```

#### 分子8（プロパン）のエッジ
```
軌道0のエッジ（110個）:
  5(H) -> 0(C): 1.095 Å  (C-H結合)
  4(H) -> 0(C): 1.095 Å  (C-H結合)
  3(H) -> 0(C): 1.095 Å  (C-H結合)
  2(C) -> 0(C): 1.519 Å  (C-C結合)
  1(C) -> 0(C): 1.519 Å  (C-C結合)
  ... (全110個のエッジ)
```

## まとめ

`get_geo_data`関数は、分子の幾何学的データをE3NNで処理可能な形式に変換する重要な関数です。主な特徴は：

1. **分子軌道のブロードキャスト**: 各分子軌道に対して原子情報を複製
2. **グラフ構造の自動生成**: 原子間の結合関係を自動検出
3. **統一された形状**: 異なるサイズの分子を同じ形状に変換
4. **E3NN互換性**: 等変ニューラルネットワークで直接使用可能
5. **エッジの物理的意味**: 化学結合と非結合相互作用の両方を含む

この変換により、分子の幾何学的構造と分子軌道の情報が統合され、機械学習モデルで効率的に処理できるようになります。
