# MO Embeddings形状分析：QM7データセット（10分子）

## 概要

本ドキュメントでは、`qm7maker.py`と`dataprep.py`で生成された10個の分子データについて、`mo_embeddings_canonical_original.pt`の形状を詳細に分析し、なぜその形状になるのかを説明します。

## 各分子のMO Embeddings形状

### 形状の一覧表

| 分子ID | 形状 | 分子軌道数 | 原子数 | 特徴次元 | 原子種 |
|--------|------|------------|--------|----------|--------|
| 0 | `[34, 5, 18]` | 34 | 5 | 18 | C, H, H, H, H |
| 1 | `[58, 8, 18]` | 58 | 8 | 18 | C, C, H, H, H, H, H, H |
| 2 | `[48, 6, 18]` | 48 | 6 | 18 | C, C, H, H, H, H |
| 3 | `[38, 4, 18]` | 38 | 4 | 18 | C, C, H, H |
| 4 | `[72, 9, 18]` | 72 | 9 | 18 | C, C, O, H, H, H, H, H, H |
| 5 | `[62, 7, 18]` | 62 | 7 | 18 | C, C, O, H, H, H, H |
| 6 | `[72, 9, 18]` | 72 | 9 | 18 | C, O, C, H, H, H, H, H, H |
| 7 | `[72, 9, 18]` | 72 | 9 | 18 | C, C, C, H, H, H, H, H, H |
| 8 | `[82, 11, 18]` | 82 | 11 | 18 | C, C, C, H, H, H, H, H, H, H, H |
| 9 | `[72, 9, 18]` | 72 | 9 | 18 | C, C, C, H, H, H, H, H, H |

### 形状の詳細分析

#### 1. 分子軌道数（第1次元）

分子軌道数は、各分子の基底関数数と等しくなります：

- **分子0（メタン）**: 34軌道
  - C原子: 14基底関数（1s, 2s, 3s, 2px, 2py, 2pz, 3px, 3py, 3pz, 3dxy, 3dyz, 3dz², 3dxz, 3dx²-y²）
  - H原子×4: 5基底関数×4 = 20基底関数
  - 合計: 14 + 20 = 34軌道

- **分子1（エタン）**: 58軌道
  - C原子×2: 14基底関数×2 = 28基底関数
  - H原子×6: 5基底関数×6 = 30基底関数
  - 合計: 28 + 30 = 58軌道

- **分子8（最大）**: 82軌道
  - C原子×3: 14基底関数×3 = 42基底関数
  - H原子×8: 5基底関数×8 = 40基底関数
  - 合計: 42 + 40 = 82軌道

#### 2. 原子数（第2次元）

原子数は、各分子の構成原子数と一致します：

- **最小**: 分子3（4原子）- C₂H₂
- **最大**: 分子8（11原子）- C₃H₈

#### 3. 特徴次元（第3次元）

すべての分子で特徴次元は**18次元**で統一されています。これは以下の理由によります：

## 特徴次元18の内訳

### エネルギーなしの場合の計算

特徴次元18は以下の成分から構成されます：

1. **原子種埋め込み**: 0次元
   - エネルギーありの場合、原子種情報は別途管理されるため、埋め込みベクトルには含まれない

2. **軌道寄与**: 14次元
   - E3NN既約表現 `3x0e+2x1o+1x2e` の次元
   - 計算: 3×1 + 2×3 + 1×5 = 3 + 6 + 5 = 14次元
   - 各成分の意味：
     - `3x0e`: 3個のs軌道（スカラー、各1次元）
     - `2x1o`: 2個のp軌道（ベクトル、各3次元）
     - `1x2e`: 1個のd軌道（テンソル、5次元）

3. **追加の4次元**: 原子種に関連した特徴
   - 軌道寄与（14次元）に追加される4次元
   - エネルギー情報は別途`mo_energies.pt`として保存
   - **C原子のみに非ゼロ値、H原子はすべてゼロ**
   - 連続値（one-hotエンコーディングではない）
   - 値の大きさは10^-6から10^-3の範囲

### パディング処理の詳細

各原子の軌道係数は、`max_n_per_l`パラメータに基づいてパディングされます：

```python
max_n_per_l = {0: 3, 1: 2, 2: 1}  # s軌道3個、p軌道2個、d軌道1個
```

- **s軌道**: 最大3個まで（1s, 2s, 3s）
- **p軌道**: 最大2個まで（2p, 3p）
- **d軌道**: 最大1個まで（3d）

### 具体例：メタン分子（分子0）

#### 原子ごとのirrep文字列

- **C原子**: `1x0e+1x0e+1x0e+1x1o+1x1o+1x2e`
  - 3個のs軌道（1x0e×3）
  - 2個のp軌道（1x1o×2）
  - 1個のd軌道（1x2e×1）

- **H原子**: `1x0e+1x0e+1x1o`
  - 2個のs軌道（1x0e×2）
  - 1個のp軌道（1x1o×1）
  - パディングにより1個のs軌道と1個のp軌道が追加

#### 形状の決定要因

1. **分子軌道数（34）**: 基底関数数と等しい
2. **原子数（5）**: C原子1個 + H原子4個
3. **特徴次元（18）**: 軌道寄与（14） + 追加特徴（4）

## 形状の一貫性

### 特徴次元の統一

すべての分子で特徴次元が18次元で統一されている理由：

1. **パディング処理**: 各原子の軌道係数が統一された次元にパディングされる
2. **E3NN互換性**: 機械学習モデルで一貫した処理が可能
3. **バッチ処理**: 異なる分子を同じバッチで処理可能

### 分子軌道数の変動

分子軌道数は分子のサイズに依存：

- **小さな分子**: 34軌道（メタン）
- **中程度の分子**: 48-72軌道
- **大きな分子**: 82軌道（最大）

### 原子数の変動

原子数は分子の構成に依存：

- **最小**: 4原子（C₂H₂）
- **最大**: 11原子（C₃H₈）

## データ構造の意味

### 3次元テンソルの解釈

`mo_embeddings_canonical_original.pt`の形状 `[n_mo, n_atom, n_features]` は：

- **第1次元（n_mo）**: 各分子軌道
- **第2次元（n_atom）**: 各原子
- **第3次元（n_features）**: 各原子の特徴ベクトル

### 機械学習での使用

この形状により：

1. **分子軌道ごとの処理**: 各分子軌道を独立に処理可能
2. **原子ごとの特徴**: 各原子の軌道寄与を個別に分析可能
3. **バッチ処理**: 複数の分子を同時に処理可能

## まとめ

`mo_embeddings_canonical_original.pt`の形状は、以下の要因によって決定されます：

1. **分子軌道数**: 基底関数数と等しく、分子のサイズに依存
2. **原子数**: 分子の構成原子数
3. **特徴次元**: パディング処理により統一（18次元）

この統一された形状により、異なるサイズの分子を同じ機械学習モデルで効率的に処理できるようになっています。特徴次元18は、軌道寄与（14次元）と追加特徴（4次元、おそらく原子種埋め込み）の合計であり、E3NNで処理可能な形式に変換されています。

## 重要な発見

### エネルギー情報の分離

実際のデータ処理では、分子軌道エネルギーは`mo_embeddings_canonical_original.pt`には含まれず、別途`mo_energies.pt`として保存されています。これにより：

1. **埋め込みベクトル**: 軌道寄与（14次元）+ 追加特徴（4次元）= 18次元
2. **エネルギー情報**: 別ファイル（`mo_energies.pt`）として保存
3. **分離の利点**: エネルギー情報を独立して処理可能

### 追加の4次元の正体

特徴次元18のうち、軌道寄与14次元を除いた4次元は、**原子種に関連した特徴**です。

#### 観察された特徴

1. **C原子**: すべて非ゼロ値を持つ
2. **H原子**: すべてゼロ値
3. **値の性質**: 連続値（one-hotエンコーディングではない）
4. **値の範囲**: 10^-6から10^-3の範囲

#### 推測される正体

この4次元は以下のいずれかの可能性があります：

1. **原子種の埋め込みベクトル**: 学習済みの原子種表現
2. **原子種の物理的性質**: 原子量、電気陰性度など
3. **原子種の化学的性質**: 価電子数、原子半径など
4. **その他の原子種特徴**: 分子内での原子種の役割

#### 正確な正体の特定

この4次元の正確な正体を特定するには、MODataprepのコードで`mo_embeddings_canonical_original`が18次元に変換される箇所を特定する必要があります。現在の分析では、`embed_mos_on_atoms`関数の結果（14次元）に何らかの処理で4次元が追加されていることが判明しています。
